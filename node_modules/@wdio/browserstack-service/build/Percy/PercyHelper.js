// ======= Percy helper methods start =======
import { PercyLogger } from './PercyLogger.js';
import Percy from './Percy.js';
export const startPercy = async (options, config, bsConfig) => {
    PercyLogger.debug('Starting percy');
    const percy = new Percy(options, config, bsConfig);
    const response = await percy.start();
    if (response) {
        return percy;
    }
    return {};
};
export const stopPercy = async (percy) => {
    PercyLogger.debug('Stopping percy');
    return percy.stop();
};
export const getBestPlatformForPercySnapshot = (capabilities) => {
    try {
        const percyBrowserPreference = { 'chrome': 0, 'firefox': 1, 'edge': 2, 'safari': 3 };
        let bestPlatformCaps = null;
        let bestBrowser = null;
        if (Array.isArray(capabilities)) {
            capabilities
                .flatMap((c) => {
                if (Object.values(c).length > 0 && Object.values(c).every(c => typeof c === 'object' && c.capabilities)) {
                    return Object.values(c).map((o) => o.capabilities);
                }
                return c;
            }).forEach((capability) => {
                let currBrowserName = capability.browserName;
                if (capability['bstack:options']) {
                    currBrowserName = capability['bstack:options'].browserName || currBrowserName;
                }
                if (!bestBrowser || !bestPlatformCaps || (bestPlatformCaps.deviceName || bestPlatformCaps['bstack:options']?.deviceName)) {
                    bestBrowser = currBrowserName;
                    bestPlatformCaps = capability;
                }
                else if (currBrowserName && percyBrowserPreference[currBrowserName.toLowerCase()] < percyBrowserPreference[bestBrowser.toLowerCase()]) {
                    bestBrowser = currBrowserName;
                    bestPlatformCaps = capability;
                }
            });
            return bestPlatformCaps;
        }
        else if (typeof capabilities === 'object') {
            Object.entries(capabilities).forEach(([, caps]) => {
                let currBrowserName = caps.capabilities.browserName;
                if (caps.capabilities['bstack:options']) {
                    currBrowserName = caps.capabilities['bstack:options']?.browserName || currBrowserName;
                }
                if (!bestBrowser || !bestPlatformCaps || (bestPlatformCaps.deviceName || bestPlatformCaps['bstack:options']?.deviceName)) {
                    bestBrowser = currBrowserName;
                    bestPlatformCaps = caps.capabilities;
                }
                else if (currBrowserName && percyBrowserPreference[currBrowserName.toLowerCase()] < percyBrowserPreference[bestBrowser.toLowerCase()]) {
                    bestBrowser = currBrowserName;
                    bestPlatformCaps = caps.capabilities;
                }
            });
            return bestPlatformCaps;
        }
    }
    catch (err) {
        PercyLogger.error(`Error while trying to determine best platform for Percy snapshot ${err}`);
        return null;
    }
};
